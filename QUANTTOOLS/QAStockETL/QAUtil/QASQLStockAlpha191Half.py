import cx_Oracle
import pandas as pd
import datetime
from QUANTAXIS.QAUtil import QA_util_log_info
from  QUANTAXIS.QAUtil import (QA_util_date_stamp,QA_util_today_str,
                               QA_util_if_trade,QA_util_get_pre_trade_date)
from QUANTTOOLS.QAStockETL.QAData.database_settings import (Oracle_Database, Oracle_User, Oracle_Password, Oralce_Server, MongoDB_Server, MongoDB_Database)

ORACLE_PATH2 = '{user}/{password}@{server}:1521/{database}'.format(database = Oracle_Database, password = Oracle_Password, server = Oralce_Server, user = Oracle_User)

sql_text = '''select to_char(ORDER_DATE, 'yyyy-mm-dd') as "date",
CODE AS "code",
ALPHA_001 as ALPHA_001_HALF,
ALPHA_002 as ALPHA_002_HALF,
ALPHA_003 as ALPHA_003_HALF,
ALPHA_004 as ALPHA_004_HALF,
ALPHA_005 as ALPHA_005_HALF,
ALPHA_006 as ALPHA_006_HALF,
ALPHA_007 as ALPHA_007_HALF,
ALPHA_008 as ALPHA_008_HALF,
ALPHA_009 as ALPHA_009_HALF,
ALPHA_010 as ALPHA_010_HALF,
ALPHA_011 as ALPHA_011_HALF,
ALPHA_012 as ALPHA_012_HALF,
ALPHA_013 as ALPHA_013_HALF,
ALPHA_014 as ALPHA_014_HALF,
ALPHA_015 as ALPHA_015_HALF,
ALPHA_016 as ALPHA_016_HALF,
ALPHA_018 as ALPHA_018_HALF,
ALPHA_019 as ALPHA_019_HALF,
ALPHA_020 as ALPHA_020_HALF,
ALPHA_021 as ALPHA_021_HALF,
ALPHA_022 as ALPHA_022_HALF,
ALPHA_023 as ALPHA_023_HALF,
ALPHA_024 as ALPHA_024_HALF,
ALPHA_025 as ALPHA_025_HALF,
ALPHA_028 as ALPHA_028_HALF,
ALPHA_029 as ALPHA_029_HALF,
ALPHA_031 as ALPHA_031_HALF,
ALPHA_032 as ALPHA_032_HALF,
ALPHA_034 as ALPHA_034_HALF,
ALPHA_035 as ALPHA_035_HALF,
ALPHA_036 as ALPHA_036_HALF,
ALPHA_037 as ALPHA_037_HALF,
ALPHA_038 as ALPHA_038_HALF,
ALPHA_040 as ALPHA_040_HALF,
ALPHA_041 as ALPHA_041_HALF,
ALPHA_042 as ALPHA_042_HALF,
ALPHA_043 as ALPHA_043_HALF,
ALPHA_044 as ALPHA_044_HALF,
ALPHA_046 as ALPHA_046_HALF,
ALPHA_047 as ALPHA_047_HALF,
ALPHA_048 as ALPHA_048_HALF,
ALPHA_049 as ALPHA_049_HALF,
ALPHA_052 as ALPHA_052_HALF,
ALPHA_053 as ALPHA_053_HALF,
ALPHA_054 as ALPHA_054_HALF,
ALPHA_056 as ALPHA_056_HALF,
ALPHA_057 as ALPHA_057_HALF,
ALPHA_058 as ALPHA_058_HALF,
ALPHA_059 as ALPHA_059_HALF,
ALPHA_060 as ALPHA_060_HALF,
ALPHA_061 as ALPHA_061_HALF,
ALPHA_062 as ALPHA_062_HALF,
ALPHA_063 as ALPHA_063_HALF,
ALPHA_064 as ALPHA_064_HALF,
ALPHA_065 as ALPHA_065_HALF,
ALPHA_066 as ALPHA_066_HALF,
ALPHA_067 as ALPHA_067_HALF,
ALPHA_068 as ALPHA_068_HALF,
ALPHA_070 as ALPHA_070_HALF,
ALPHA_071 as ALPHA_071_HALF,
ALPHA_072 as ALPHA_072_HALF,
ALPHA_074 as ALPHA_074_HALF,
ALPHA_076 as ALPHA_076_HALF,
ALPHA_077 as ALPHA_077_HALF,
ALPHA_078 as ALPHA_078_HALF,
ALPHA_079 as ALPHA_079_HALF,
ALPHA_080 as ALPHA_080_HALF,
ALPHA_081 as ALPHA_081_HALF,
ALPHA_082 as ALPHA_082_HALF,
ALPHA_083 as ALPHA_083_HALF,
ALPHA_084 as ALPHA_084_HALF,
ALPHA_085 as ALPHA_085_HALF,
ALPHA_086 as ALPHA_086_HALF,
ALPHA_087 as ALPHA_087_HALF,
ALPHA_088 as ALPHA_088_HALF,
ALPHA_089 as ALPHA_089_HALF,
ALPHA_090 as ALPHA_090_HALF,
ALPHA_091 as ALPHA_091_HALF,
ALPHA_093 as ALPHA_093_HALF,
ALPHA_094 as ALPHA_094_HALF,
ALPHA_095 as ALPHA_095_HALF,
ALPHA_096 as ALPHA_096_HALF,
ALPHA_097 as ALPHA_097_HALF,
ALPHA_098 as ALPHA_098_HALF,
ALPHA_099 as ALPHA_099_HALF,
ALPHA_100 as ALPHA_100_HALF,
ALPHA_101 as ALPHA_101_HALF,
ALPHA_102 as ALPHA_102_HALF,
ALPHA_103 as ALPHA_103_HALF,
ALPHA_104 as ALPHA_104_HALF,
ALPHA_105 as ALPHA_105_HALF,
ALPHA_106 as ALPHA_106_HALF,
ALPHA_107 as ALPHA_107_HALF,
ALPHA_109 as ALPHA_109_HALF,
ALPHA_111 as ALPHA_111_HALF,
ALPHA_112 as ALPHA_112_HALF,
ALPHA_114 as ALPHA_114_HALF,
ALPHA_115 as ALPHA_115_HALF,
ALPHA_117 as ALPHA_117_HALF,
ALPHA_118 as ALPHA_118_HALF,
ALPHA_119 as ALPHA_119_HALF,
ALPHA_120 as ALPHA_120_HALF,
ALPHA_122 as ALPHA_122_HALF,
ALPHA_123 as ALPHA_123_HALF,
ALPHA_124 as ALPHA_124_HALF,
ALPHA_125 as ALPHA_125_HALF,
ALPHA_126 as ALPHA_126_HALF,
ALPHA_129 as ALPHA_129_HALF,
ALPHA_130 as ALPHA_130_HALF,
ALPHA_132 as ALPHA_132_HALF,
ALPHA_133 as ALPHA_133_HALF,
ALPHA_134 as ALPHA_134_HALF,
ALPHA_135 as ALPHA_135_HALF,
ALPHA_136 as ALPHA_136_HALF,
ALPHA_139 as ALPHA_139_HALF,
ALPHA_141 as ALPHA_141_HALF,
ALPHA_142 as ALPHA_142_HALF,
ALPHA_145 as ALPHA_145_HALF,
ALPHA_148 as ALPHA_148_HALF,
ALPHA_150 as ALPHA_150_HALF,
ALPHA_152 as ALPHA_152_HALF,
ALPHA_153 as ALPHA_153_HALF,
ALPHA_154 as ALPHA_154_HALF,
ALPHA_155 as ALPHA_155_HALF,
ALPHA_156 as ALPHA_156_HALF,
ALPHA_157 as ALPHA_157_HALF,
ALPHA_158 as ALPHA_158_HALF,
ALPHA_160 as ALPHA_160_HALF,
ALPHA_161 as ALPHA_161_HALF,
ALPHA_163 as ALPHA_163_HALF,
ALPHA_164 as ALPHA_164_HALF,
ALPHA_167 as ALPHA_167_HALF,
ALPHA_168 as ALPHA_168_HALF,
ALPHA_169 as ALPHA_169_HALF,
ALPHA_170 as ALPHA_170_HALF,
ALPHA_172 as ALPHA_172_HALF,
ALPHA_173 as ALPHA_173_HALF,
ALPHA_174 as ALPHA_174_HALF,
ALPHA_175 as ALPHA_175_HALF,
ALPHA_177 as ALPHA_177_HALF,
ALPHA_178 as ALPHA_178_HALF,
ALPHA_179 as ALPHA_179_HALF,
ALPHA_180 as ALPHA_180_HALF,
ALPHA_185 as ALPHA_185_HALF,
ALPHA_186 as ALPHA_186_HALF,
ALPHA_187 as ALPHA_187_HALF,
ALPHA_188 as ALPHA_188_HALF,
ALPHA_189 as ALPHA_189_HALF,
ALPHA_191 as ALPHA_191_HALF
from stock_alpha191_half
where order_Date >=
to_date('{from_}', 'yyyy-mm-dd')
and order_Date <=
to_date('{to_}', 'yyyy-mm-dd')
'''

def QA_Sql_Stock_Alpha191Half(from_ , to_, sql_text = sql_text, ui_log= None):
    QA_util_log_info(
        '##JOB01 Now Fetch Stock QuantData Alpha191 Half ==== from {from_} to {to_}'.format(from_=from_,to_=to_), ui_log)
    sql_text = sql_text.format(from_=from_,to_=to_)
    conn = cx_Oracle.connect(ORACLE_PATH2)
    data = pd.read_sql(sql=sql_text, con=conn)
    conn.close()
    return(data.drop_duplicates((['code', 'date'])).set_index(['date','code']).groupby('code').fillna(method='ffill'))