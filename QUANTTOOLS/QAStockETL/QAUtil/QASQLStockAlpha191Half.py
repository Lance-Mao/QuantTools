import cx_Oracle
import pandas as pd
import datetime
from QUANTAXIS.QAUtil import QA_util_log_info
from  QUANTAXIS.QAUtil import (QA_util_date_stamp,QA_util_today_str,
                               QA_util_if_trade,QA_util_get_pre_trade_date)
from QUANTTOOLS.QAStockETL.QAData.database_settings import (Oracle_Database, Oracle_User, Oracle_Password, Oralce_Server, MongoDB_Server, MongoDB_Database)

ORACLE_PATH2 = '{user}/{password}@{server}:1521/{database}'.format(database = Oracle_Database, password = Oracle_Password, server = Oralce_Server, user = Oracle_User)

sql_text = '''select to_char(ORDER_DATE, 'yyyy-mm-dd') as "date",
CODE AS "code",
ALPHA_001 as ALPHA_001HALF,
ALPHA_002 as ALPHA_002HALF,
ALPHA_003 as ALPHA_003HALF,
ALPHA_004 as ALPHA_004HALF,
ALPHA_005 as ALPHA_005HALF,
ALPHA_006 as ALPHA_006HALF,
ALPHA_007 as ALPHA_007HALF,
ALPHA_008 as ALPHA_008HALF,
ALPHA_009 as ALPHA_009HALF,
ALPHA_010 as ALPHA_010HALF,
ALPHA_011 as ALPHA_011HALF,
ALPHA_012 as ALPHA_012HALF,
ALPHA_013 as ALPHA_013HALF,
ALPHA_014 as ALPHA_014HALF,
ALPHA_015 as ALPHA_015HALF,
ALPHA_016 as ALPHA_016HALF,
ALPHA_018 as ALPHA_018HALF,
ALPHA_019 as ALPHA_019HALF,
ALPHA_020 as ALPHA_020HALF,
ALPHA_021 as ALPHA_021HALF,
ALPHA_022 as ALPHA_022HALF,
ALPHA_023 as ALPHA_023HALF,
ALPHA_024 as ALPHA_024HALF,
ALPHA_025 as ALPHA_025HALF,
ALPHA_028 as ALPHA_028HALF,
ALPHA_029 as ALPHA_029HALF,
ALPHA_031 as ALPHA_031HALF,
ALPHA_032 as ALPHA_032HALF,
ALPHA_034 as ALPHA_034HALF,
ALPHA_035 as ALPHA_035HALF,
ALPHA_036 as ALPHA_036HALF,
ALPHA_037 as ALPHA_037HALF,
ALPHA_038 as ALPHA_038HALF,
ALPHA_040 as ALPHA_040HALF,
ALPHA_041 as ALPHA_041HALF,
ALPHA_042 as ALPHA_042HALF,
ALPHA_043 as ALPHA_043HALF,
ALPHA_044 as ALPHA_044HALF,
ALPHA_046 as ALPHA_046HALF,
ALPHA_047 as ALPHA_047HALF,
ALPHA_048 as ALPHA_048HALF,
ALPHA_049 as ALPHA_049HALF,
ALPHA_052 as ALPHA_052HALF,
ALPHA_053 as ALPHA_053HALF,
ALPHA_054 as ALPHA_054HALF,
ALPHA_056 as ALPHA_056HALF,
ALPHA_057 as ALPHA_057HALF,
ALPHA_058 as ALPHA_058HALF,
ALPHA_059 as ALPHA_059HALF,
ALPHA_060 as ALPHA_060HALF,
ALPHA_061 as ALPHA_061HALF,
ALPHA_062 as ALPHA_062HALF,
ALPHA_063 as ALPHA_063HALF,
ALPHA_064 as ALPHA_064HALF,
ALPHA_065 as ALPHA_065HALF,
ALPHA_066 as ALPHA_066HALF,
ALPHA_067 as ALPHA_067HALF,
ALPHA_068 as ALPHA_068HALF,
ALPHA_070 as ALPHA_070HALF,
ALPHA_071 as ALPHA_071HALF,
ALPHA_072 as ALPHA_072HALF,
ALPHA_074 as ALPHA_074HALF,
ALPHA_076 as ALPHA_076HALF,
ALPHA_077 as ALPHA_077HALF,
ALPHA_078 as ALPHA_078HALF,
ALPHA_079 as ALPHA_079HALF,
ALPHA_080 as ALPHA_080HALF,
ALPHA_081 as ALPHA_081HALF,
ALPHA_082 as ALPHA_082HALF,
ALPHA_083 as ALPHA_083HALF,
ALPHA_084 as ALPHA_084HALF,
ALPHA_085 as ALPHA_085HALF,
ALPHA_086 as ALPHA_086HALF,
ALPHA_087 as ALPHA_087HALF,
ALPHA_088 as ALPHA_088HALF,
ALPHA_089 as ALPHA_089HALF,
ALPHA_090 as ALPHA_090HALF,
ALPHA_091 as ALPHA_091HALF,
ALPHA_093 as ALPHA_093HALF,
ALPHA_094 as ALPHA_094HALF,
ALPHA_095 as ALPHA_095HALF,
ALPHA_096 as ALPHA_096HALF,
ALPHA_097 as ALPHA_097HALF,
ALPHA_098 as ALPHA_098HALF,
ALPHA_099 as ALPHA_099HALF,
ALPHA_100 as ALPHA_100HALF,
ALPHA_101 as ALPHA_101HALF,
ALPHA_102 as ALPHA_102HALF,
ALPHA_103 as ALPHA_103HALF,
ALPHA_104 as ALPHA_104HALF,
ALPHA_105 as ALPHA_105HALF,
ALPHA_106 as ALPHA_106HALF,
ALPHA_107 as ALPHA_107HALF,
ALPHA_109 as ALPHA_109HALF,
ALPHA_111 as ALPHA_111HALF,
ALPHA_112 as ALPHA_112HALF,
ALPHA_114 as ALPHA_114HALF,
ALPHA_115 as ALPHA_115HALF,
ALPHA_117 as ALPHA_117HALF,
ALPHA_118 as ALPHA_118HALF,
ALPHA_119 as ALPHA_119HALF,
ALPHA_120 as ALPHA_120HALF,
ALPHA_122 as ALPHA_122HALF,
ALPHA_123 as ALPHA_123HALF,
ALPHA_124 as ALPHA_124HALF,
ALPHA_125 as ALPHA_125HALF,
ALPHA_126 as ALPHA_126HALF,
ALPHA_129 as ALPHA_129HALF,
ALPHA_130 as ALPHA_130HALF,
ALPHA_132 as ALPHA_132HALF,
ALPHA_133 as ALPHA_133HALF,
ALPHA_134 as ALPHA_134HALF,
ALPHA_135 as ALPHA_135HALF,
ALPHA_136 as ALPHA_136HALF,
ALPHA_139 as ALPHA_139HALF,
ALPHA_141 as ALPHA_141HALF,
ALPHA_142 as ALPHA_142HALF,
ALPHA_145 as ALPHA_145HALF,
ALPHA_148 as ALPHA_148HALF,
ALPHA_150 as ALPHA_150HALF,
ALPHA_152 as ALPHA_152HALF,
ALPHA_153 as ALPHA_153HALF,
ALPHA_154 as ALPHA_154HALF,
ALPHA_155 as ALPHA_155HALF,
ALPHA_156 as ALPHA_156HALF,
ALPHA_157 as ALPHA_157HALF,
ALPHA_158 as ALPHA_158HALF,
ALPHA_160 as ALPHA_160HALF,
ALPHA_161 as ALPHA_161HALF,
ALPHA_163 as ALPHA_163HALF,
ALPHA_164 as ALPHA_164HALF,
ALPHA_167 as ALPHA_167HALF,
ALPHA_168 as ALPHA_168HALF,
ALPHA_169 as ALPHA_169HALF,
ALPHA_170 as ALPHA_170HALF,
ALPHA_172 as ALPHA_172HALF,
ALPHA_173 as ALPHA_173HALF,
ALPHA_174 as ALPHA_174HALF,
ALPHA_175 as ALPHA_175HALF,
ALPHA_177 as ALPHA_177HALF,
ALPHA_178 as ALPHA_178HALF,
ALPHA_179 as ALPHA_179HALF,
ALPHA_180 as ALPHA_180HALF,
ALPHA_185 as ALPHA_185HALF,
ALPHA_186 as ALPHA_186HALF,
ALPHA_187 as ALPHA_187HALF,
ALPHA_188 as ALPHA_188HALF,
ALPHA_189 as ALPHA_189HALF,
ALPHA_191 as ALPHA_191HALF
from stock_alpha191_half
where order_Date >=
to_date('{from_}', 'yyyy-mm-dd')
and order_Date <=
to_date('{to_}', 'yyyy-mm-dd')
'''

def QA_Sql_Stock_Alpha191Half(from_ , to_, sql_text = sql_text, ui_log= None):
    QA_util_log_info(
        '##JOB01 Now Fetch Stock QuantData Alpha191 Half ==== from {from_} to {to_}'.format(from_=from_,to_=to_), ui_log)
    sql_text = sql_text.format(from_=from_,to_=to_)
    conn = cx_Oracle.connect(ORACLE_PATH2)
    data = pd.read_sql(sql=sql_text, con=conn)
    conn.close()
    return(data.drop_duplicates((['code', 'date'])).set_index(['date','code']).groupby('code').fillna(method='ffill'))